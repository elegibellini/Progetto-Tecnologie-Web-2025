{% extends 'accounts/main.html' %}
{% load static %}

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
{% block content %}
<div class="container mt-5">
    <h2>Area Riservata ai Lavoratori</h2>
    <hr>

    <h4>Prenotazioni future</h4>
    <ul>
        {% for p in prenotazioni_future %}
            <li>{{ p.data|date:"d/m/Y" }} alle {{ p.ora|time:"H:i" }} – {{ p.numero_persone }} persone – {{ p.utente.username }}</li>
        {% empty %}
            <li>Nessuna prenotazione futura.</li>
        {% endfor %}
    </ul>

    <hr>
    <h4>Giorni non prenotabili</h4>
    <div id="calendar" style="max-width: 900px; margin: 40px auto;"></div>
    <form method="post" class="form-inline mb-3">
        {% csrf_token %}
        {{ form_giorno.as_p }}
        <input type="hidden" name="blocca_giorno" value="1">
        <button type="submit" class="btn btn-outline-dark ml-2">Blocca giorno</button>
    </form>

    <ul>
        {% for g in giorni_bloccati %}
            <li>{{ g.data|date:"d/m/Y" }}</li>
        {% empty %}
            <li>Nessun giorno bloccato.</li>
        {% endfor %}
    </ul>

    <hr>
    <div class="mt-4">
        {% if request.user.is_superuser %}
            <a href="/admin" class="btn btn-warning mb-3">Modifica Menu</a>
            <a href="{% url 'storico_ordini_completo' %}" class="btn btn-secondary mb-3">Storico Ordini</a>

        {% else %}
            <button type="button" class="btn btn-primary mr-2" onclick="alert('Solo il Manager può accedere a tale sezione')">Modifica menu</button>
            <button type="button" class="btn btn-secondary" onclick="alert('Solo il Manager può accedere a tale sezione')">Storico prenotazioni</button>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var giorniBloccati = JSON.parse('{{ giorni_bloccati_js|safe|escapejs }}');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            selectable: true,
            dateClick: function(info) {
                const data = info.dateStr;

                if (giorniBloccati.includes(data)) {
                    alert("Il giorno " + data + " è già bloccato.");
                    return;
                }

                if (confirm("Vuoi bloccare il giorno " + data + " per le prenotazioni?")) {
                   
                    fetch("{% url 'amministrazione' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: "blocca_giorno=1&data=" + data
                    }).then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        } else {
                            window.location.reload();
                        }
                    });
                }
            },
            events: giorniBloccati.map(data => ({
                title: 'NON DISPONIBILE',
                start: data,
                color: '#dc3545'  
            }))
        });

        calendar.render();
    });
</script>


{% endblock %}
